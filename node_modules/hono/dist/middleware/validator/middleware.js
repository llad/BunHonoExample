import { getStatusText } from '../../utils/http-status';
import { VBase, Validator } from './validator';
export const validatorMiddleware = (validationFunction, options) => {
    const v = new Validator();
    const handler = async (c, next) => {
        const resultSet = {
            hasError: false,
            messages: [],
            results: [],
        };
        const validatorList = getValidatorList(validationFunction(v, c));
        for (const [keys, validator] of validatorList) {
            let result;
            try {
                result = await validator.validate(c.req);
            }
            catch (e) {
                // Invalid JSON request
                return c.text(getStatusText(400), 400);
            }
            if (result.isValid) {
                // Set data on request object
                c.req.valid(keys, result.value);
            }
            else {
                resultSet.hasError = true;
                if (result.message !== undefined) {
                    resultSet.messages.push(result.message);
                }
            }
            resultSet.results.push(result);
        }
        if (options && options.done) {
            const res = options.done(resultSet, c);
            if (res) {
                return res;
            }
        }
        if (resultSet.hasError) {
            return c.text(resultSet.messages.join('\n'), 400);
        }
        await next();
    };
    return handler;
};
function getValidatorList(schema) {
    const map = [];
    for (const [key, value] of Object.entries(schema)) {
        if (value instanceof VBase) {
            map.push([[key], value]);
        }
        else {
            const children = getValidatorList(value);
            for (const [keys, validator] of children) {
                map.push([[key, ...keys], validator]);
            }
        }
    }
    return map;
}
